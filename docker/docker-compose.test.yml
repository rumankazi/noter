# Cross-platform E2E testing with GUI support
services:
  # Ubuntu Linux complete testing with GUI support
  test-ubuntu:
    build:
      context: ..
      dockerfile: docker/Dockerfile.ubuntu-gui
    volumes:
      - ../test-results:/app/test-results
      - ../playwright-report:/app/playwright-report
    environment:
      - NODE_ENV=test
      - ELECTRON_DISABLE_SANDBOX=1
      - DISPLAY=:99
      - CI=true
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
    command: >
      bash -c "
        echo '🧪 Running complete Ubuntu test suite...'
        echo '📋 Running linter...'
        pnpm run lint
        echo '🔧 Running unit tests...'
        pnpm run test
        echo '🏗️  Building application...'
        pnpm run build
        echo '🖥️  Starting virtual display for E2E tests...'
        Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
        sleep 3
        echo '🧪 Running E2E tests...'
        pnpm run test:e2e
        echo '✅ Ubuntu test suite completed!'
      "
    mem_limit: 2g
    cpus: 2

  # macOS-like complete testing (Ubuntu-based with GUI)
  test-macos:
    build:
      context: ..
      dockerfile: docker/Dockerfile.macos-gui
    volumes:
      - ../test-results:/app/test-results
      - ../playwright-report:/app/playwright-report
    environment:
      - NODE_ENV=test
      - ELECTRON_DISABLE_SANDBOX=1
      - DISPLAY=:99
      - CI=true
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
    command: >
      bash -c "
        echo '🧪 Running complete macOS-like test suite...'
        echo '📋 Running linter...'
        pnpm run lint
        echo '🔧 Running unit tests...'
        pnpm run test
        echo '🏗️  Building application...'
        pnpm run build
        echo '🖥️  Starting virtual display for E2E tests...'
        Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset &
        sleep 3
        echo '🧪 Running E2E tests...'
        pnpm run test:e2e
        echo '✅ macOS-like test suite completed!'
      "
    mem_limit: 2g
    cpus: 2

  # Windows complete testing (requires Windows Docker host)
  test-windows:
    build:
      context: ..
      dockerfile: docker/Dockerfile.windows-gui
    volumes:
      - ../test-results:C:/app/test-results
      - ../playwright-report:C:/app/playwright-report
    environment:
      - NODE_ENV=test
      - ELECTRON_DISABLE_SANDBOX=1
      - CI=true
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
    command: >
      cmd /c "
        echo 🧪 Running complete Windows test suite...
        echo 📋 Running linter...
        pnpm run lint
        echo 🔧 Running unit tests...
        pnpm run test
        echo 🏗️ Building application...
        pnpm run build
        echo 🧪 Running E2E tests...
        pnpm run test:e2e
        echo ✅ Windows test suite completed!
      "
    mem_limit: 4g
    cpus: 2
    platform: windows/amd64
    profiles:
      - windows # Only build when explicitly requested
